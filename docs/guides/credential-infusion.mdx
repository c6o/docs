---
sidebar_position: 2
---

# Credential infusion

Codezero's crendential infusion allows consuming services without the need to set up secrets within local development environments. E.g. a database can be accessed from local development without knowing the username and password. The Codezero space agent will infuse credentials on the fly.

```mermaid
flowchart LR
  direction LR
  subgraph Kubernetes
    Secret[Database Credentials]-->spaceagent[Codezero Spaceagent]
    spaceagent-->ExternalService[External Service]
  end
  localDev[Local Postgres client]-->spaceagent
  ExternalService-->Database[(Database)]
```

## Setup credential infusion

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
<TabItem value="postgres" label="Postgres" default>
  1. Create a kubernetes secret holding the database credentials in the codezero namespace. The secret name must match the external service name and namespace create in step 2.

  ```yaml
  apiVersion: v1
  kind: Secret
  metadata:
    name: my-postgres.demo
    namespace: codezero
  type: Opaque
  stringData:
    username: my-user
    password: my-password
  ```

  2. Create an external kubernetes service pointing to the target database. The annotation `codezero.io/credential-infusion: postgres` instructs the Codezero space agent to infuse credentials for this database.

  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      codezero.io/credential-infusion: postgres
    name: my-postgres
    namespace: demo
  spec:
    externalName: my-postgres.cluyia0mwn9q.us-east-2.rds.amazonaws.com
    ports:
    - port: 5432
      protocol: TCP
      targetPort: 5432
    type: ExternalName
  ```

  3. Consume `my-postgres.demo` service via the Codezero desktop app or `czctl`

  ```bash
  echo "my-postgres/demo" | czctl consume apply
  ```

  4. Use any postgres client in local development to connect to the database. E.g. with psql cli:

  ```bash
  psql -h my-postgres.demo
  ```
</TabItem>
<TabItem value="http" label="HTTP header infusion">
  HTTP header infusion can be used to connect to external HTTPS services.

  1. Create a kubernetes secret holding the header and value to authenticate to the external https services. The secret name must match the external service name and namespace create in step 2.

  ```yaml
  apiVersion: v1
  kind: Secret
  metadata:
    name: my-http-service
    namespace: codezero
  type: Opaque
  stringData:
    key: Authorization
    value: Basic Zm9vYmFyCg==
  ```

  2. Create an external kubernetes service pointing to the target HTTPS service.

  ```yaml
  apiVersion: v1
  kind: Service
  metadata:
    annotations:
      codezero.io/credential-infusion: http
    name: my-http-service
    namespace: demo
  spec:
    externalName: some.external-service.com
    ports:
    - port: 80
      protocol: TCP
      targetPort: 443
    type: ExternalName
  ```

  3. Consume `my-http-service.demo` service via the Codezero desktop app or `czctl`

  ```bash
  echo "my-http-service/demo" | czctl consume apply
  ```

  4. Use any http client to send http requests to `http://my-http-service.demo`

  ```bash
  curl http://my-http-service.demo/my-api
  ```
</TabItem>
</Tabs>

:::note
Changing a credential secret requires a rolling the spaceagent deployment.

```bash
kubectl rollout restart deployment -n codezero spaceagent
```
:::